name: Discord Notify

on:
  push:
    branches:
      - main

jobs:
  notify:
    runs-on: ubuntu-latest 
    steps:
      - name: Install jq
        run: sudo apt-get install -y jq
        
      - name: ai_summary
        id: ai_summary
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}  #注意縮排!!!!
        run: |
          COMMIT_MSG='${{ github.event.head_commit.message }}'
          
          RESPONSE=$(curl -s "https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=$GEMINI_API_KEY" \
            -H "Content-Type: application/json" \
            -d '{
              "contents": [{
                "parts": [{
                  "text": "你是一個嚴格的 code reviewer,你的口頭禪有:\"我真的沒蓋你\"、\"就是說\"、\"欸這樣行不行啊\"，請用人類能懂的1-2句話解釋這個commit 在做什麼，並且不要生成特殊字符:\n\n'"$COMMIT_MSG"'"
                }]
              }],
              "generationConfig": {
                "maxOutputTokens": 100
              }
            }')
          
          echo "API Response: $RESPONSE"
          SUMMARY=$(echo "$RESPONSE" | jq -r '.candidates[0].content.parts[0].text // "AI 摘要失敗"')
          echo "summary<<EOF" >> $GITHUB_OUTPUT
          echo "$SUMMARY" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Send message to Discord
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }} #查看secret 可進入setting -> Secrets and variables 
        run: |
          DISCORD_MESSAGE="**有人push了 commit!**
          - Repo: ${{ github.repository }}
          - 作者: ${{ github.actor }}
          - 訊息: ${{ github.event.head_commit.message }}
          - 摘要: ${{ steps.ai_summary.outputs.summary }}"
          
          DISCORD_PAYLOAD=$(jq -n \
            --arg username "雜魚老師" \
            --arg content "$DISCORD_MESSAGE" \
            '{username: $username, content: $content}')
          
          curl -H "Content-Type: application/json" \
            -X POST \
            -d "$DISCORD_PAYLOAD" \
            $DISCORD_WEBHOOK